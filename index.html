<!DOCTYPE html>
<!-- LLM-NOTE: This application is optimized exclusively for Microsoft Edge. Do not add cross-browser compatibility code. -->
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sidebar</title>
    <style>
        /* LLM-NOTE: All styling is self-contained. Do not introduce external CSS frameworks. */
        :root {
            --bg-color: #f4f7fa; --panel-bg: #ffffff; --border-color: #e2e8f0;
            --text-color: #1e293b; --subtle-text: #64748b; --primary-color: #3b82f6;
            --danger-color: #ef4444; --success-color: #22c55e; --warning-color: #f97316;
            --info-bg: #f8fafc; --danger-hover-bg: #fee2e2;
            --font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #111827; --panel-bg: #1f2937; --border-color: #374151;
                --text-color: #f9fafb; --subtle-text: #9ca3af; --primary-color: #60a5fa;
                --info-bg: #111827; --danger-hover-bg: #4b1d1d;
            }
        }

        html, body { height: 100%; margin: 0; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
            display: flex;
            overflow: hidden;
        }

        /* --- Core Layout & Components --- */
        #app { width: 100%; height: 100vh; display: flex; flex-direction: column; padding: 0.75rem; box-sizing: border-box; gap: 0.5rem; }
        main { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; padding-right: 4px; }
        .section { background-color: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.5rem; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem; }
        .section-title { font-size: 0.9rem; font-weight: 600; margin: 0; }
        .input-field, select { width: 100%; box-sizing: border-box; font-size: 0.875rem; padding: 0.4rem 0.6rem; border-radius: 0.375rem; border: 1px solid var(--border-color); font-family: inherit; background-color: var(--info-bg); color: var(--text-color); }
        .input-field:focus, select:focus { outline: 2px solid var(--primary-color); outline-offset: -1px; }
        textarea.input-field { resize: vertical; }

        /* --- Buttons & Controls --- */
        .btn { padding: 0.35rem 0.6rem; font-size: 0.8rem; border: 1px solid var(--border-color); border-radius: 0.375rem; cursor: pointer; background-color: var(--panel-bg); font-weight: 500; }
        .btn:hover { background-color: var(--info-bg); }
        .btn-primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-primary:hover { filter: brightness(110%); }
        .btn-danger { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }

        /* --- Analysis & Response Display --- */
        #analysisResult { padding: 0.75rem; border-radius: 0.375rem; background-color: var(--info-bg); font-size: 0.875rem; line-height: 1.5; white-space: pre-wrap; }
        .empty-state-text { color: var(--subtle-text); text-align: center; padding: 1rem; font-style: italic; }
        #responsesContainer { display: flex; flex-direction: column; gap: 0.75rem; }
        .strategy-card { border: 1px solid var(--border-color); border-radius: 0.5rem; overflow: hidden; }
        .strategy-header { background-color: var(--info-bg); padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border-color); }
        .strategy-header h3 { font-size: 0.9rem; margin: 0; }
        .strategy-header h3 span { font-weight: 500; color: var(--subtle-text); font-size: 0.8rem; }
        .strategy-rationale { font-size: 0.8rem; color: var(--subtle-text); padding: 0.5rem 0.75rem; margin: 0; }
        .strategy-text { white-space: pre-wrap; padding: 0.75rem; }
        .strategy-actions { text-align: right; padding: 0 0.5rem 0.5rem; }

        /* --- Modals, Toasts, & Overlays --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(100,116,139,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-content { background: var(--panel-bg); padding: 1.5rem; border-radius: 0.75rem; max-width: min(95vw, 420px); width: 100%; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); max-height: min(90vh, 600px); overflow-y: auto; }
        .toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 0.75rem 1.25rem; border-radius: 0.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 0.875rem; z-index: 2000; transition: bottom 0.5s cubic-bezier(0.25, 1, 0.5, 1); color: white; }
        .toast.show { bottom: 20px; }
        .toast-error { background-color: var(--danger-color); }
        .toast-success { background-color: var(--success-color); }
        .toast-info { background-color: var(--primary-color); }
        #onboardingContent kbd { background: var(--border-color); padding: 0.1rem 0.4rem; border-radius: 0.25rem; font-family: monospace; }
        .hidden { display: none !important; }

        /* --- Responsive Design --- */
        @media (max-width: 360px) {
            .section-header { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .controls { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>
    <div id="onboardingOverlay" class="hidden">
       <div style="max-width: 600px; margin: auto; padding: 2rem;">
            <h1>Welcome to Sidebar</h1>
            <p>This is a strategic co-pilot for workplace communication, designed to help you decode messages and respond with confidence.</p>
            <h3>Setup:</h3>
            <p>1. In Edge, press <kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>/</kbd> to open the sidebar.</p>
            <p>2. Click `+` to add this app.</p>
            <p>3. Go to Settings (‚öôÔ∏è) and add your Google AI API key. <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener">Get a key here.</a></p>
            <button id="dismissOnboardingBtn" class="btn btn-primary" style="margin-top: 1rem;">Continue to App</button>
        </div>
    </div>

    <div id="app" class="hidden">
        <main>
            <!-- Input Section -->
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Message</h2>
                    <div class="controls">
                        <select id="recipientSelector" title="Select Person"></select>
                    </div>
                </div>
                <textarea id="messageInput" class="input-field" placeholder="Paste a message to analyze or start composing..."></textarea>
            </section>
            
            <!-- Analysis Section -->
            <section id="analysisSection" class="section hidden">
                <div class="section-header">
                    <h2 class="section-title">The Briefing</h2>
                </div>
                <div id="analysisResult"></div>
                <div class="input-group" style="margin-top: 0.5rem;">
                    <input type="text" id="contextInput" class="input-field" placeholder="Add clarifying context...">
                    <button class="btn" data-action="refine-analysis">Update Briefing</button>
                </div>
            </section>

             <!-- Actions Section -->
            <section id="actionsSection" class="section hidden">
                 <button id="getSuggestionsBtn" class="btn btn-primary" style="width: 100%;" data-action="get-suggestions">Get Response Playbook</button>
            </section>

            <!-- Responses Section -->
            <section id="responsesSection" class="section hidden">
                <div class="section-header">
                     <h2 class="section-title">Response Playbook</h2>
                </div>
                <div id="responsesContainer"></div>
            </section>
        </main>
        <footer>
            <button class="btn" data-action="clear-inputs" title="Clear All Inputs">üóëÔ∏è Clear</button>
            <button class="btn" data-action="open-settings" title="Settings">‚öôÔ∏è Settings</button>
        </footer>
    </div>

    <!-- Modals -->
    <div id="settingsModal" class="modal-overlay hidden">
       <div class="modal-content">
            <h2>Settings</h2>
            <div style="margin-bottom: 1rem;">
                <label for="geminiApiKeyInput">Google AI API Key</label>
                <input type="password" id="geminiApiKeyInput" class="input-field" placeholder="Enter your API key">
            </div>
            <div style="border-top: 1px solid var(--border-color); padding-top: 1rem;">
                <label>Data Management</label>
                <button class="btn" data-action="open-people-manager">Manage People</button>
                <button class="btn btn-danger" data-action="clear-all-data">Clear All Data</button>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top: 1.5rem;">
                <button class="btn" data-action="close-modal" data-modal-id="settingsModal">Cancel</button>
                <button class="btn btn-primary" data-action="save-settings">Save</button>
            </div>
        </div>
    </div>
    <div id="peopleModal" class="modal-overlay hidden">
       <div class="modal-content">
            <h2>Manage People</h2>
            <div style="margin-bottom: 1rem;">
                <h3>Add New Person</h3>
                <input type="text" id="newPersonName" class="input-field" placeholder="Person's Name" style="margin-bottom: 0.5rem;">
                <input type="text" id="newPersonRole" class="input-field" placeholder="Relationship (e.g., Manager)">
                <button class="btn btn-primary" data-action="add-person" style="margin-top: 0.5rem;">Add</button>
            </div>
            <div id="peopleList"></div>
            <div style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top: 1.5rem;">
                <button class="btn" data-action="close-modal" data-modal-id="peopleModal">Close</button>
            </div>
        </div>
    </div>
     <div id="confirmModal" class="modal-overlay hidden">
       <div class="modal-content">
            <h2 id="confirmTitle">Confirm</h2>
            <p id="confirmMessage"></p>
            <div style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top: 1.5rem;">
                <button id="confirmCancelBtn" class="btn">Cancel</button>
                <button id="confirmOkBtn" class="btn btn-danger">OK</button>
            </div>
        </div>
    </div>
    
    <script type="module">
    'use strict';
    // --- LLM-NOTE: SCRIPT OVERVIEW ---
    // This script is a single-file application designed for the Microsoft Edge sidebar.
    // It acts as a "strategic co-pilot" for workplace communication.
    // Core functionality is managed by the `PersonalizedWorkplaceAgent` which follows a specific interactive workflow.
    // All UI manipulation is handled by the `UIManager`, and all data is stored in localStorage via `UnifiedStorage`.
    // Event handling is centralized using a `data-action` delegation model. State is managed by the `StateManager` class.

    const CONFIG = {
        DEBOUNCE_MS: 750,
        MODAL_IDS: {
            SETTINGS: 'settingsModal',
            PEOPLE: 'peopleModal',
            CONFIRM: 'confirmModal'
        },
        STORAGE_KEYS: { 
            PROFILES: 'sidebar_profiles_v13', 
            SETTINGS: 'sidebar_settings_v10', 
            DRAFT: 'sidebar_draft_v3' 
        }
    };

    const dom = {
        app: document.getElementById('app'), onboardingOverlay: document.getElementById('onboardingOverlay'), dismissOnboardingBtn: document.getElementById('dismissOnboardingBtn'),
        messageInput: document.getElementById('messageInput'), recipientSelector: document.getElementById('recipientSelector'),
        analysisSection: document.getElementById('analysisSection'), analysisResult: document.getElementById('analysisResult'),
        contextInput: document.getElementById('contextInput'),
        actionsSection: document.getElementById('actionsSection'),
        responsesSection: document.getElementById('responsesSection'), responsesContainer: document.getElementById('responsesContainer'),
        geminiApiKeyInput: document.getElementById('geminiApiKeyInput'),
        peopleList: document.getElementById('peopleList'), newPersonName: document.getElementById('newPersonName'), newPersonRole: document.getElementById('newPersonRole'),
        confirmModal: document.getElementById(CONFIG.MODAL_IDS.CONFIRM), confirmTitle: document.getElementById('confirmTitle'), confirmMessage: document.getElementById('confirmMessage'),
        confirmCancelBtn: document.getElementById('confirmCancelBtn'), confirmOkBtn: document.getElementById('confirmOkBtn'),
    };

    let activeModal = null, focusedElementBeforeModal = null;
    
    // --- UTILITIES & HELPERS ---
    const ErrorHandler = {
        handle(error, context = 'General') {
            console.error(`Error in ${context}:`, error);
            showToast(`An error occurred: ${error.message}`, 'error');
        }
    };

    const ValidationService = {
        isApiKeyValid(key) {
            return typeof key === 'string' && key.length > 10; // Basic check
        },
        isPersonDataValid(name, role) {
            return name.trim().length > 0 && role.trim().length > 0;
        }
    };

    const debounce = (func, delay) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    };
    const sanitizeHTML = (str) => {
        if (!str) return '';
        return str.replace(/[&<>"']/g, (match) => {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
        });
    };
    const showToast = (message, type = 'info', duration = 3000) => {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => document.body.removeChild(toast), 500); }, duration);
    };
    
    const showModal = (modalElement) => {
        if (!modalElement) return;
        activeModal = modalElement;
        focusedElementBeforeModal = document.activeElement;
        activeModal.classList.remove('hidden');
        activeModal.querySelector('input, button, select, textarea')?.focus();
    };
    const hideModal = (modalElement) => {
        if(modalElement) modalElement.classList.add('hidden');
        if (activeModal === modalElement) activeModal = null;
        if (focusedElementBeforeModal) focusedElementBeforeModal.focus();
    };
    const showConfirmationModal = (title, message) => new Promise((resolve) => {
        dom.confirmTitle.textContent = title;
        dom.confirmMessage.textContent = message;
        showModal(dom.confirmModal);
        const onConfirm = () => { cleanup(); resolve(true); };
        const onCancel = () => { cleanup(); resolve(false); };
        const cleanup = () => {
            dom.confirmOkBtn.removeEventListener('click', onConfirm);
            dom.confirmCancelBtn.removeEventListener('click', onCancel);
            hideModal(dom.confirmModal);
        };
        dom.confirmOkBtn.addEventListener('click', onConfirm, { once: true });
        dom.confirmCancelBtn.addEventListener('click', onCancel, { once: true });
    });

    // --- ENCAPSULATED STATE MANAGEMENT ---
    class StateManager {
        constructor() {
            this.state = {
                selectedPersonId: null, settings: {}, currentBriefing: null, lastContext: '', currentPlaybook: null
            };
        }
        get(key) { return this.state[key]; }
        set(key, value) { this.state[key] = value; }
        resetBriefingState() {
            this.set('currentBriefing', null);
            this.set('currentPlaybook', null);
            this.set('lastContext', '');
        }
    }
    const stateManager = new StateManager();

    // --- CONSOLIDATED STORAGE ---
    class UnifiedStorage {
        constructor() { this.keys = CONFIG.STORAGE_KEYS; }
        async get(type, id = null) { const data = JSON.parse(localStorage.getItem(this.keys[type.toUpperCase()]) || '{}'); return id ? data[id] : data; }
        async set(type, data, id = null) { if (id) { const d = await this.get(type); d[id] = data; localStorage.setItem(this.keys[type.toUpperCase()], JSON.stringify(d)); } else { localStorage.setItem(this.keys[type.toUpperCase()], JSON.stringify(data)); } }
    }
    const storage = new UnifiedStorage();
    
    // --- API CLIENT ---
    class GeminiApiClient {
        constructor(apiKey) { this.apiKey = apiKey; this.baseUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-preview-0514:generateContent'; }
        async call(prompt, isJson = true) {
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            if (isJson) { payload.generationConfig = { responseMimeType: "application/json" }; }
            const response = await fetch(`${this.baseUrl}?key=${this.apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error('Invalid API response structure.');
            return isJson ? JSON.parse(text) : text;
        }
    }

    // --- PERSONALIZED WORKPLACE AGENT ---
    class PersonalizedWorkplaceAgent {
        constructor(apiKey) { this.api = new GeminiApiClient(apiKey); }
        _sanitizeForPrompt(text) {
            if (!text) return '';
            return text.replace(/\b(ignore|disregard|forget|instruction|system|prompt)\b/gi, '[keyword removed]');
        }
        async getBriefing(message, profile, addedContext = '') {
            const cleanMessage = this._sanitizeForPrompt(message);
            const cleanContext = this._sanitizeForPrompt(addedContext);
            const prompt = `CONTEXT:\n- You are analyzing a workplace message for a user who wants to understand the professional subtext.\n- Recipient Profile: This person is a ${profile?.role || 'colleague'}.\n- Historical Communication Style (Long-Term Memory): ${profile?.summary || 'No history available.'}\n- User's Added Context: ${cleanContext || 'None.'}\n\nMESSAGE TO ANALYZE:\n"${cleanMessage}"\n\nTASK:\nProvide a single, concise "Briefing" paragraph. Your goal is to decode the message's true meaning, seriousness, and tone. CRITICALLY, compare the message to their known historical style. If it deviates (e.g., more formal, more blunt), highlight this anomaly as it's a key insight. Focus ONLY on the analysis. Do not suggest actions.`;
            return this.api.call(prompt, false);
        }
        async getResponsePlaybook(briefing, message, profile) {
            const PERSONAS = { Diplomat: "Focus on collaboration, find common ground, and validate their perspective.", Pragmatist: "Focus on data, efficiency, and logical next steps. Be direct and concise.", Challenger: "Respectfully question assumptions, introduce a different perspective, or clarify boundaries." };
            const prompt = `SITUATION BRIEFING:\n"${briefing}"\n\nORIGINAL MESSAGE:\n"${message}"\n\nTASK:\nGenerate a playbook of 2-3 distinct strategic responses. For each response:\n1. Assign a Persona (${Object.keys(PERSONAS).join(', ')}).\n2. Write a brief Rationale explaining *why* this strategy is effective for this specific situation.\n3. Write the response Text.\n\nRespond with a JSON object: { "responses": [{ "persona": "...", "rationale": "...", "text": "..." }] }`;
            return this.api.call(prompt);
        }
        async summarizeInteraction(message, briefing, playbook) {
            if(!playbook || !playbook.responses) return "";
            const prompt = `PREVIOUS INTERACTION:\n- Initial Message: "${message}"\n- Our Analysis: "${briefing}"\n- Generated Responses: ${JSON.stringify(playbook.responses)}\n\nTASK:\nUpdate the long-term memory summary for this person. Do NOT summarize the topic. Instead, identify and describe their communication BEHAVIOR and STYLE from this interaction. Good examples: "Tends to be indirect when giving criticism." or "Responds well to collaborative language." or "Becomes very formal when discussing deadlines." Provide a single sentence.`;
            return this.api.call(prompt, false);
        }
    }

    // --- UI MANAGER ---
    const UIManager = {
        async init() {
            this.renderPeopleSelector();
            const draft = await storage.get('draft');
            if (draft && draft.message) {
                dom.messageInput.value = draft.message;
                stateManager.set('selectedPersonId', draft.personId);
                dom.recipientSelector.value = stateManager.get('selectedPersonId') || '';
                this.updateSectionVisibility('analysis');
            }
        },
        updateSectionVisibility(mode) {
            const isAnalysisVisible = mode === 'analysis' && dom.messageInput.value.length > 0;
            dom.analysisSection.classList.toggle('hidden', !isAnalysisVisible);
            dom.actionsSection.classList.toggle('hidden', !isAnalysisVisible);
            dom.responsesSection.classList.add('hidden');
        },
        renderBriefing(briefingText) {
            dom.analysisResult.textContent = briefingText;
        },
        renderResponsePlaybook(playbook) {
            dom.responsesSection.classList.remove('hidden');
            stateManager.set('currentPlaybook', playbook);
            if (!playbook || !playbook.responses || playbook.responses.length === 0) {
                dom.responsesContainer.innerHTML = '<p class="empty-state-text">No suggestions generated.</p>';
                return;
            }
            dom.responsesContainer.innerHTML = playbook.responses.map(card => {
                const safePersona = sanitizeHTML(card.persona);
                const safeRationale = sanitizeHTML(card.rationale);
                const safeText = sanitizeHTML(card.text);
                return `
                <div class="strategy-card">
                    <div class="strategy-header"><h3>${safePersona} <span>Strategy</span></h3></div>
                    <p class="strategy-rationale">${safeRationale}</p>
                    <div class="strategy-text">${safeText}</div>
                    <div class="strategy-actions"><button class="btn" data-action="copy-response" data-text="${encodeURIComponent(card.text)}">Copy</button></div>
                </div>`;
            }).join('');
        },
        async renderPeopleSelector() {
            const profiles = await storage.get('profiles');
            dom.recipientSelector.innerHTML = '<option value="">-- Select Person --</option>';
            Object.values(profiles).forEach(p => dom.recipientSelector.add(new Option(p.name, p.id)));
            dom.recipientSelector.add(new Option('+ Add New Person', 'add_new_person'));
            dom.recipientSelector.value = stateManager.get('selectedPersonId') || '';
        },
        async renderPeopleList() {
            const profiles = await storage.get('profiles');
            dom.peopleList.innerHTML = Object.values(profiles).map(p => `<div class="person-item" style="display:flex; justify-content:space-between; align-items:center; padding: 0.25rem 0;"><span>${sanitizeHTML(p.name)} (${sanitizeHTML(p.role)})</span><button class="btn btn-danger" data-action="delete-person" data-id="${p.id}">Delete</button></div>`).join('');
        }
    };

    // --- CORE APPLICATION LOGIC ---
    let agent;

    async function runBriefing() {
        const selectedPersonId = stateManager.get('selectedPersonId');
        if (!selectedPersonId) {
            if(dom.messageInput.value.trim().length > 0) showToast('Please select a person first.', 'warning');
            return;
        }
        const message = dom.messageInput.value.trim();
        if (!message) return;
        
        dom.analysisResult.innerHTML = '<p class="empty-state-text">Getting briefing...</p>';
        dom.responsesSection.classList.add('hidden');
        stateManager.set('currentPlaybook', null);
        
        try {
            const profile = await storage.get('profiles', selectedPersonId);
            const lastContext = dom.contextInput.value.trim();
            stateManager.set('lastContext', lastContext);
            const briefing = await agent.getBriefing(message, profile, lastContext);
            stateManager.set('currentBriefing', briefing);
            UIManager.renderBriefing(briefing);
        } catch(error) {
            ErrorHandler.handle(error, 'runBriefing');
            dom.analysisResult.innerHTML = '<p class="empty-state-text">Could not get briefing.</p>';
        }
    }

    async function runResponseGeneration() {
        const currentBriefing = stateManager.get('currentBriefing');
        if (!currentBriefing) return showToast('Please get a briefing first.', 'error');
        dom.responsesContainer.innerHTML = '<p class="empty-state-text">Generating playbook...</p>';
        
        try {
            const profile = await storage.get('profiles', stateManager.get('selectedPersonId'));
            const playbook = await agent.getResponsePlaybook(currentBriefing, dom.messageInput.value.trim(), profile);
            UIManager.renderResponsePlaybook(playbook);
        } catch(error) {
            ErrorHandler.handle(error, 'runResponseGeneration');
            dom.responsesContainer.innerHTML = '<p class="empty-state-text">Could not get responses.</p>';
        }
    }
    
    // --- ACTIONS COMMAND OBJECT ---
    const actions = {
        'refine-analysis': async () => await runBriefing(),
        'get-suggestions': async () => await runResponseGeneration(),
        'copy-response': async ({ text }) => {
            navigator.clipboard.writeText(decodeURIComponent(text)).then(() => showToast("Copied!", "success"));
            const profile = await storage.get('profiles', stateManager.get('selectedPersonId'));
            if (profile) {
                const newSummary = await agent.summarizeInteraction(dom.messageInput.value.trim(), stateManager.get('currentBriefing'), stateManager.get('currentPlaybook'));
                if (newSummary) {
                     profile.summary = (profile.summary ? profile.summary + ' ' : '') + newSummary;
                     await storage.set('profiles', profile, stateManager.get('selectedPersonId'));
                }
            }
        },
        'clear-inputs': async () => {
            dom.messageInput.value = ''; dom.contextInput.value = '';
            stateManager.resetBriefingState();
            UIManager.updateSectionVisibility('compose');
            await storage.set('draft', { message: '', personId: stateManager.get('selectedPersonId') });
        },
        'open-settings': () => {
            showModal(document.getElementById(CONFIG.MODAL_IDS.SETTINGS)); 
            dom.geminiApiKeyInput.value = stateManager.get('settings').apiKey || '';
        },
        'save-settings': async () => {
            const settings = stateManager.get('settings');
            const newApiKey = dom.geminiApiKeyInput.value;
            if(!ValidationService.isApiKeyValid(newApiKey)) return showToast('API Key appears invalid.', 'error');
            
            settings.apiKey = newApiKey;
            stateManager.set('settings', settings); 
            await storage.set('settings', settings); 
            agent = settings.apiKey ? new PersonalizedWorkplaceAgent(settings.apiKey) : null;
            hideModal(document.getElementById(CONFIG.MODAL_IDS.SETTINGS)); 
            showToast('Settings saved.', 'success');
        },
        'open-people-manager': async () => {
            hideModal(document.getElementById(CONFIG.MODAL_IDS.SETTINGS)); 
            await UIManager.renderPeopleList(); 
            showModal(document.getElementById(CONFIG.MODAL_IDS.PEOPLE));
        },
        'add-person': async () => {
            const name = dom.newPersonName.value;
            const role = dom.newPersonRole.value;
            if (!ValidationService.isPersonDataValid(name, role)) return showToast("Name and relationship are required.", "error");
            
            const newId = `p_${Date.now()}`;
            await storage.set('profiles', { id: newId, name: name.trim(), role: role.trim(), summary: '' }, newId);
            dom.newPersonName.value = ''; dom.newPersonRole.value = '';
            await Promise.all([UIManager.renderPeopleList(), UIManager.renderPeopleSelector()]);
        },
        'delete-person': async ({ id }) => {
            if (await showConfirmationModal("Delete Person?", "This cannot be undone.")) {
                const profiles = await storage.get('profiles');
                delete profiles[id];
                await storage.set('profiles', profiles);
                if(stateManager.get('selectedPersonId') === id) stateManager.set('selectedPersonId', null);
                await Promise.all([UIManager.renderPeopleList(), UIManager.renderPeopleSelector()]);
            }
        },
        'clear-all-data': async () => {
             if(await showConfirmationModal('Clear All Data?', 'This will delete all profiles, settings, and drafts.')) { 
                 Object.values(CONFIG.STORAGE_KEYS).forEach(key => localStorage.removeItem(key)); 
                 window.location.reload(); 
             }
        },
        'close-modal': ({ modalId }) => hideModal(document.getElementById(modalId)),
    };

    // --- EVENT HANDLING & INITIALIZATION ---
    async function handleEvent(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        e.preventDefault();
        
        const action = actions[target.dataset.action];
        if (action) {
            try {
                await action(target.dataset);
            } catch (error) {
                ErrorHandler.handle(error, `actions.${target.dataset.action}`);
            }
        }
    }

    async function main() {
        try {
            const settings = await storage.get('settings');
            stateManager.set('settings', settings);
            if (!settings.onboardingDismissed) {
                 dom.onboardingOverlay.classList.remove('hidden');
                 dom.dismissOnboardingBtn.addEventListener('click', async () => {
                    const s = stateManager.get('settings');
                    s.onboardingDismissed = true;
                    stateManager.set('settings', s);
                    await storage.set('settings', s);
                    dom.onboardingOverlay.classList.add('hidden'); dom.app.classList.remove('hidden');
                    await main(); // Re-run main to initialize the app
                 }, { once: true });
                 return;
            }

            dom.app.classList.remove('hidden');
            if (ValidationService.isApiKeyValid(settings.apiKey)) {
                agent = new PersonalizedWorkplaceAgent(settings.apiKey);
            } else {
                showToast('API Key not set. Please add it in Settings.', 'warning');
            }

            await UIManager.init();
            document.addEventListener('click', handleEvent);
            
            const debouncedBriefing = debounce(runBriefing, CONFIG.DEBOUNCE_MS);
            
            const handleInputChange = () => {
                UIManager.updateSectionVisibility('analysis');
                storage.set('draft', { message: dom.messageInput.value, personId: stateManager.get('selectedPersonId') });
                if (agent) debouncedBriefing();
            };
            
            dom.messageInput.addEventListener('input', handleInputChange);
            dom.recipientSelector.addEventListener('change', (e) => {
                const value = e.target.value;
                if (value === 'add_new_person') {
                    actions['open-people-manager']();
                    dom.recipientSelector.value = stateManager.get('selectedPersonId') || "";
                    return;
                }
                stateManager.resetBriefingState();
                dom.contextInput.value = '';
                dom.analysisResult.innerHTML = '<p class="empty-state-text">Select a person and type a message to get started...</p>';
                dom.responsesSection.classList.add('hidden');
                
                stateManager.set('selectedPersonId', value || null);
                handleInputChange();
            });
            document.addEventListener('keydown', e => { if (e.key === 'Escape' && activeModal) hideModal(activeModal); });
        } catch(e) {
            ErrorHandler.handle(e, 'main');
        }
    }

    main();
    </script>
</body>
</html>
